name: ssh-slurm-singularity-gdrive

layers:
  ssh:
    type: ssh
    host: csc
    user: qtn

  # ─── Schedulers ───
  slurm:
    type: slurm
    partition: gpu
    time: "04:00:00"
    gpus: 1
    cpus: 4
    memory: 32G

  # ─── Containers ───
  singularity:
    type: singularity
    image: docker://ghcr.io/astral-sh/uv:0.9.13-python3.12-alpine

  docker:
    type: docker
    image: ghcr.io/astral-sh/uv:0.9.13-python3.12-alpine

storage:
  code-direct-git:
    type: git-direct
    depends_on: ssh
 
  # Direct mount - use existing local path
  code-local:
    type: mount
    source: .  # current directory

  # Git clone - for remote execution
  code-github:
    type: git
    repo: github.com/quatton/ssh-slurm-singularity-gdrive
    auth:
      type: gh

  data:
    type: gdrive
    folder_id: 1ABC123xyz
    path: /workspace/data
    readonly: true
    auth:
      type: service-account
      key: ~/.config/gdrive-sa.json

  runs:
    type: gdrive
    folder_id: 1XYZ789abc
    path: /workspace/runs
    sync: on-exit  # upload logs/artifacts when job finishes
    auth:
      type: service-account
      key: ~/.config/gdrive-sa.json
  
runners:
  # SSH only (simple remote execution)
  ssh:
    layers:
      - ssh
    storage:
      source: code-direct-git

  # Full HPC: SSH → Slurm → Singularity
  hpc:
    layers:
      - ssh
      - slurm
      - singularity
    storage:
      source: code-github  # clone on remote
      data: data
      run: runs

  # Local Docker (for testing)
  container:
    layers:
      - docker
    storage:
      source: code-local  # direct mount

  # Default: no layers, just run locally
  # (implicit when no runner specified)
